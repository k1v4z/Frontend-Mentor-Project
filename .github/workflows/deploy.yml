name: Deploy Only Changed Projects

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed projects
        id: detect
        run: |
          echo "Detecting changed projects..."
          changed_dirs=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
            | awk -F/ '{print $1}' | sort -u)

          mkdir public
          projects_deployed=()

          for dir in $changed_dirs; do
            if [ -f "$dir/index.html" ]; then
              echo "Preparing deploy for: $dir"
              mkdir -p "public/$dir"
              cp -r "$dir"/* "public/$dir"
              projects_deployed+=("$dir")
            fi
          done

          echo "deployed=$(IFS=, ; echo "${projects_deployed[*]}")" >> $GITHUB_OUTPUT

      - name: Deploy changed projects
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public

      - name: Log deployed projects
        run: |
          echo "Deployed Projects:"
          for project in ${{ steps.detect.outputs.deployed }}; do
            echo "- $project"
          done
