name: Deploy Frontend Mentor Projects

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for git diff

      - name: Detect changed projects
        id: detect
        run: |
          echo "Detecting changed projects..."

          # Get the previous commit SHA
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            # First push to branch
            PREV_SHA="HEAD~1"
          else
            PREV_SHA="${{ github.event.before }}"
          fi

          # Find changed directories (projects)
          changed_dirs=$(git diff --name-only $PREV_SHA ${{ github.sha }} \
            | grep -E '^[^/]+/' \
            | cut -d'/' -f1 \
            | sort -u)

          echo "Changed directories: $changed_dirs"

          # Create public directory structure
          mkdir -p public

          # Create index.html for main page listing all projects
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Frontend Mentor Projects</title>
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                  .project { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
                  .project h3 { margin-top: 0; }
                  .project a { color: #007bff; text-decoration: none; }
                  .project a:hover { text-decoration: underline; }
                  .updated { background-color: #e8f5e8; border-color: #28a745; }
              </style>
          </head>
          <body>
              <h1>Frontend Mentor Projects</h1>
              <div id="projects"></div>
              <script>
                  // This will be populated by the workflow
              </script>
          </body>
          </html>
          EOF

          projects_deployed=()
          projects_updated=()

          # Copy all projects (not just changed ones) to maintain full site
          for dir in */; do
            dir=${dir%/}  # Remove trailing slash
            
            # Skip certain directories
            if [ "$dir" = "public" ] || [ "$dir" = ".github" ] || [ "$dir" = "node_modules" ]; then
              echo "Skipping directory: $dir"
              continue
            fi
            
            if [ -f "$dir/index.html" ]; then
              echo "Copying project: $dir"
              mkdir -p "public/$dir"
              cp -r "$dir"/* "public/$dir/"
              projects_deployed+=("$dir")
              
              # Check if this project was changed
              if echo "$changed_dirs" | grep -q "^$dir$"; then
                projects_updated+=("$dir")
                echo "Project $dir was updated"
              fi
            fi
          done

          # Generate projects list for index.html
          projects_js="const projects = ["
          for project in "${projects_deployed[@]}"; do
            is_updated=""
            if echo "$changed_dirs" | grep -q "^$project$"; then
              is_updated="updated"
            fi
            projects_js="$projects_js{name:'$project',updated:'$is_updated'},"
          done
          projects_js="${projects_js%,}];"

          # Update index.html with projects list
          cat >> public/index.html << EOF
          <script>
          $projects_js

          const projectsDiv = document.getElementById('projects');
          projects.forEach(project => {
              const div = document.createElement('div');
              div.className = 'project' + (project.updated ? ' updated' : '');
              div.innerHTML = \`
                  <h3>\${project.name} \${project.updated ? 'ðŸ†•' : ''}</h3>
                  <a href="./\${project.name}/" target="_blank">View Project</a>
              \`;
              projectsDiv.appendChild(div);
          });
          </script>
          </body>
          </html>
          EOF

          # Set outputs
          echo "deployed=$(IFS=,; echo "${projects_deployed[*]}")" >> $GITHUB_OUTPUT
          echo "updated=$(IFS=,; echo "${projects_updated[*]}")" >> $GITHUB_OUTPUT
          echo "has_changes=$([ ${#projects_updated[@]} -gt 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

          echo "Total projects: ${#projects_deployed[@]}"
          echo "Updated projects: ${#projects_updated[@]}"

      - name: Deploy to GitHub Pages
        if: steps.detect.outputs.has_changes == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          commit_message: "Deploy updated projects: ${{ steps.detect.outputs.updated }}"

      - name: Log deployment summary
        run: |
          echo "Deployment Summary:"
          echo "==================="
          if [ "${{ steps.detect.outputs.has_changes }}" == "true" ]; then
            echo "Deployment completed"
            echo ""
            echo "Updated projects:"
            IFS=',' read -ra UPDATED <<< "${{ steps.detect.outputs.updated }}"
            for project in "${UPDATED[@]}"; do
              echo "   - $project"
            done
            echo ""
            echo "All deployed projects:"
            IFS=',' read -ra DEPLOYED <<< "${{ steps.detect.outputs.deployed }}"
            for project in "${DEPLOYED[@]}"; do
              echo "   - $project"
            done
            echo ""
            echo "Access your projects at:"
            echo "   Main page: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
            for project in "${UPDATED[@]}"; do
              echo "   $project: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/$project/"
            done
          else
            echo "No projects were updated, skipping deployment"
          fi
